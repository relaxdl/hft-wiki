# å…±äº«å†…å­˜åŸºç¡€

## è®¾è®¡åŸåˆ™

* ä½¿ç”¨system Vçš„å…±äº«å†…å­˜
* ä¸€ä¸ªè¿›ç¨‹è´Ÿè´£å†™(Producer)æŸä¸€å—å…±äº«å†…å­˜ï¼Œæ¯”å¦‚æŸä¸ªäº¤æ˜“æ‰€æŸä¸ªäº¤æ˜“å¯¹çš„Tickeræ•°æ®ï¼Œå¤šä¸ªè¿›ç¨‹è¯»
* å†™è¿›ç¨‹ä¸èƒ½æœ‰é”ï¼Œæ–°çš„æ•°æ®æ¥äº†ä¹‹åéšæ—¶å¯ä»¥å†™å…¥ï¼Œåªä¿ç•™å½“ä¸‹æ—¶åˆ»çš„æœ€æ–°ä¸€æ¡è®°å½•ï¼Œä¸ä¿ç•™å†å²
* è¯»è¿›ç¨‹(Consumer)ä¸èƒ½æœ‰é”ï¼Œéšæ—¶å¯ä»¥è¯»åˆ°æ•°æ®ã€‚è¯»è¿›ç¨‹ä¸è¦æ±‚å¿…é¡»è¯»åˆ°æœ€æ–°çš„æ•°æ®ï¼Œåªè¦è¯»åˆ°æœ€è¿‘ä¸€æ¡å®Œæ•´çš„æ•°æ®å°±å¯ä»¥ã€‚æ¯”å¦‚ï¼šå†™è¿›ç¨‹æ­£åœ¨å†™çš„æ•°æ®ä¸éœ€è¦è¯»ï¼Œå› ä¸ºæ•°æ®å†™äº†ä¸€åŠï¼Œæ²¡å†™å®Œä¸å®Œæ•´ã€‚åªéœ€è¦è¯»åˆšå†™å®Œçš„æœ€æ–°ä¸€æ¡å®Œæ•´æ•°æ®å°±å¯ä»¥
    * å†™è¿›ç¨‹æ€»æ˜¯åœ¨æ›´æ–°ä¸‹ä¸€ä¸ªä½ç½®ï¼Œå†™å®Œæ‰æ›´æ–°ç´¢å¼•
    * è¯»è¿›ç¨‹åªéœ€è¯»å–writerå·²å®Œæˆæ›´æ–°çš„æœ€æ–°ç´¢å¼•å³å¯
* è¯»å†™éƒ½è¦è¿½æ±‚æè‡´çš„æ€§èƒ½
* åŸå­ç´¢å¼•ä½¿ç”¨acquire/releaseè¯­ä¹‰(è¡¥å……ï¼šatomicåœ¨å¤šçº¿ç¨‹ä¸­å¯ä»¥ç”¨æ¥åŒæ­¥ï¼Œåœ¨å¤šè¿›ç¨‹ä¸­æ²¡æœ‰æ•ˆæœ)
    * å†™è¿›ç¨‹å†™ç´¢å¼•(writer_index)ï¼Œä½¿ç”¨`memory_order_release`ï¼Œè¡¨ç¤ºä¹‹å‰æ‰€æœ‰å¯¹æ•°æ®çš„å†™å…¥å¯¹è¯»è¿›ç¨‹å¯è§(å¤šè¿›ç¨‹ä¸­æ²¡æœ‰æ•ˆæœï¼Œä¿ç•™ä¹Ÿä¸å½±å“æ€§èƒ½)
    * è¯»è¿›ç¨‹è¯»ç´¢å¼•(writer_index)ï¼Œä½¿ç”¨`memory_order_acquire`ï¼Œä¿è¯è¯»è¿›ç¨‹èƒ½æ­£ç¡®çœ‹åˆ°ç´¢å¼•å‰çš„æ‰€æœ‰å†™å…¥æ“ä½œ(å¤šè¿›ç¨‹ä¸­æ²¡æœ‰æ•ˆæœï¼Œä¿ç•™ä¹Ÿä¸å½±å“æ€§èƒ½)
* è€ƒè™‘CPU Cache Lineå’ŒFalse Sharing
    * `alignas(64)`å’Œ`padding`ç¡®ä¿`Ticker`ç­‰ç»“æ„ä½“å¯¹é½CPUç¼“å­˜è¡Œï¼Œæé«˜è¯»å–æ•ˆç‡
    * æ¶ˆé™¤False Sharing
        * æ¯ä¸ªslotçš„Tickeræ•°æ®å•å…ƒæ­£å¥½å ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªcache line
        * writerå’Œreaderè¿›ç¨‹ä¸ä¼šå…±äº«åŒä¸€Cache line
        * å¤§å¹…å‡å°‘L1/L2 cacheçš„å¤±æ•ˆï¼Œæå‡ååé‡å’Œé™ä½å»¶è¿Ÿ
    * æé«˜æ•°æ®è®¿é—®å±€éƒ¨æ€§ï¼šè¯»æ•°æ®æ—¶ä¸€æ¬¡æ€§åŠ è½½å®Œæ•´cache lineï¼Œæé«˜å†…å­˜ååç‡
* ä½¿ç”¨ç¯å½¢ç¼“å†²åŒº(Ring Buffer)ï¼Œ**å‡è®¾ç¼“å†²åŒºè¶³å¤Ÿå¤§**ï¼Œæ¯”å¦‚ï¼šå°ºå¯¸æ˜¯512ï¼Œå¯ä»¥ä¿è¯è¯»è¿›ç¨‹æ­£åœ¨è¯»ä¸€ä¸ªslotçš„æ—¶å€™ï¼Œå†™è¿›ç¨‹ä¸ä¼šå†™å®Œä¸€åœˆåˆå†™å›æ¥ã€‚è¿™æ ·èƒ½ä¿è¯æ•°æ®çš„å®Œæ•´æ€§ã€‚é€šè¿‡è¿™ä¸ªå‡è®¾ï¼Œçœå»äº†è¯»çš„å®Œæ•´æ€§æ ¡éªŒæ­¥éª¤
    * æ•°æ®æŸåçš„æœ¬è´¨åŸå› æ˜¯ï¼šå½“è¯»è¿›ç¨‹æ­£åœ¨è¯»å–æŸä¸ªslotæ•°æ®æ—¶ï¼Œå†™è¿›ç¨‹æ°å¥½æ­£åœ¨åŒæ—¶å†™å…¥è¯¥slotçš„æ•°æ®ï¼Œå¯¼è‡´è¯»è¿›ç¨‹å¯èƒ½è¯»åˆ°éƒ¨åˆ†æ–°æ•°æ®å’Œéƒ¨åˆ†æ—§æ•°æ®ï¼Œå‡ºç°æ•°æ®æ’•è£‚(Data Tearing)

## System V Shared Memory

SysV å…±äº«å†…å­˜ä½¿ç”¨æ­¥éª¤éå¸¸å›ºå®š

1. **`ftok`**ï¼ˆå¯é€‰ï¼‰- ç”Ÿæˆå”¯ä¸€ key
2. **`shmget`** - åˆ›å»º/è·å–å…±äº«å†…å­˜æ®µ
3. **`shmat`** - å°†å…±äº«å†…å­˜é™„åŠ åˆ°è¿›ç¨‹åœ°å€ç©ºé—´
4. **è¯»å†™æ“ä½œ** - ç›´æ¥è®¿é—®å…±äº«å†…å­˜
5. **`shmdt`** - åˆ†ç¦»å…±äº«å†…å­˜
6. **`shmctl`** - åˆ é™¤å…±äº«å†…å­˜

## System V APIçš„å°è£…

* å¯¹system Vå…±äº«å†…å­˜APIçš„å°è£…

```c++
ç”Ÿæˆå…±äº«å†…å­˜çš„é”®å€¼ key_t
key_t generateShmKey(const std::string &path, char projId = 'a');

åˆ›å»º/è·å–å…±äº«å†…å­˜æ®µ
int createShm(key_t key, size_t size, bool overwrite = false);
int createShm(const std::string &path, size_t size, bool overwrite = false);

å°†å…±äº«å†…å­˜é™„åŠ åˆ°è¿›ç¨‹åœ°å€ç©ºé—´
void *attachShm(key_t key, size_t size, bool readOnly = false);
void *attachShm(const std::string &path, size_t size, bool readOnly = false);

åˆ†ç¦»å…±äº«å†…å­˜
int detachShm(void *shmPtr);

åˆ é™¤å…±äº«å†…å­˜
int deleteShm(key_t key, size_t size = 0);
int deleteShm(const std::string &path, size_t size = 0);

é€šè¿‡å…±äº«å†…å­˜ ID åˆ é™¤å…±äº«å†…å­˜ç©ºé—´
int deleteShmById(int shmid);
```

## System V APIæœ€ä½³å®è·µ

1. **`generateShmKey`** - ç”Ÿæˆå…±äº«å†…å­˜çš„é”®å€¼
2. **`createShm`** - åˆ›å»º/è·å–å…±äº«å†…å­˜æ®µ
3. **`attachShm`** - å°†å…±äº«å†…å­˜é™„åŠ åˆ°è¿›ç¨‹åœ°å€ç©ºé—´

ç»è¿‡ä¸Šé¢ä¸‰ä¸ªæ­¥éª¤åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨`SharedMemoryTickerData *shmPtr_`è¿™ä¸ªæŒ‡é’ˆï¼Œæ¥æ“ä½œè¿™å—å…±äº«å†…å­˜

!!! warning "æ³¨æ„"

    * åœ¨å®ç›˜ä¸­ï¼Œæˆ‘ä»¬attachçš„å†…å­˜ç»Ÿä¸€éƒ½æ˜¯Ring Bufferå°è£…åçš„æ•°æ®ç»“æ„
    * è™½ç„¶å°è£…å¥½çš„å…±äº«å†…å­˜APIæä¾›äº†overwriteçš„åŠŸèƒ½æ¥é‡æ–°åˆ›å»ºä¸€å—æ–°çš„å…±äº«å†…å­˜ï¼Œä½†æ˜¯åœ¨å®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œ**æˆ‘ä»¬æ°¸è¿œä¸ä¼šåˆ é™¤å·²æœ‰çš„ä¸€å—å…±äº«å†…å­˜å†å»é‡æ–°åˆ›å»ºå®ƒ**
    * ç›®å‰å”¯ä¸€éœ€è¦å°†ä¸€å—å·²æœ‰çš„å…±äº«å†…å­˜åˆ é™¤å†é‡æ–°åˆ›å»ºçš„ä¸šåŠ¡åœºæ™¯å°±æ˜¯ä¿®æ”¹äº†åº•å±‚çš„æ•°æ®ç»“æ„ï¼Œåœ¨åº•å±‚åŸºç¡€æ•°æ®ç»“æ„ç¨³å®šçš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªéœ€æ±‚éå¸¸å°‘ã€‚åŠæ—¶æœ‰å¿…é¡»è¦æ”¹åŠ¨çš„åœºæ™¯ï¼Œå‡çº§çš„æ—¶å€™ï¼Œé‡å¯æœåŠ¡å™¨ï¼Œé‡æ–°åˆ·æ–°æ•´ä¸ªå…±äº«å†…å­˜å³å¯ã€‚è¿™æ ·å¯ä»¥æå¤§ç®€åŒ–ä¸Šå±‚ä¸šåŠ¡é€»è¾‘æ—¶é—´

```c++ hl_lines="14 21 28 42"
class SharedMemoryTickerRingBuffer
{
public:
    /**
     * æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–å…±äº«å†…å­˜ RingBuffer
     *
     * @param exchange äº¤æ˜“æ‰€ï¼ˆæšä¸¾ç±»å‹ï¼Œå¦‚ BINANCE, OKXï¼‰
     * @param symbol äº¤æ˜“å¯¹ï¼ˆæšä¸¾ç±»å‹ï¼Œå¦‚ BTC_USDT, ETH_USDTï¼‰
     * @param overwrite æ˜¯å¦è¦†ç›–å·²æœ‰çš„å…±äº«å†…å­˜ï¼ˆé»˜è®¤ falseï¼‰
     */
    SharedMemoryTickerRingBuffer(const Exchange exchange, const CurrencyPair symbol, bool overwrite = false)
    {
        shmFilePath_ = PathManager::getShmFilePath(exchange, Channel::TICKER, symbol);
        shmKey_ = generateShmKey(shmFilePath_);
        if (shmKey_ < 0)
        {
            perror("generateShmKey error");
            exit(1);
        }

        shmid_ = createShm(shmKey_, sizeof(SharedMemoryTickerData), overwrite);
        if (shmid_ < 0)
        {
            perror("createShm error");
            exit(1);
        }

        shmPtr_ = static_cast<SharedMemoryTickerData *>(attachShm(shmKey_, sizeof(SharedMemoryTickerData), false));
        if (!shmPtr_)
        {
            perror("attachShm error");
            exit(1);
        }
    }

    // ...

private:
    std::string shmFilePath_;
    key_t shmKey_;
    int shmid_;
    SharedMemoryTickerData *shmPtr_ = nullptr;
};
```

## Tickeræ¡ˆä¾‹

ä»¥Tickerä¸ºæ¡ˆä¾‹ä»‹ç»ï¼Œå…¶å®ƒç±»å‹çš„æ•°æ®å®ç°æ–¹å¼å’Œå¯¹å¤–çš„æ¥å£éƒ½æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œä¸»è¦æ¶‰åŠå¦‚ä¸‹å››ä¸ªæ•°æ®ç»“æ„

* Tickerï¼šåŸºç¡€æ•°æ®ç»“æ„
* SharedMemoryTickerDataï¼šå…±äº«å†…å­˜å¸ƒå±€Ring Buffer
* SharedMemoryTickerRingBufferï¼šRing Bufferç®¡ç†ç±»ï¼Œæä¾›æ“ä½œæ¥å£
* ğŸ”¥ SharedMemoryTickerï¼šå…¨å±€Ring Bufferç®¡ç†å™¨ï¼Œä¸Šå±‚ä½¿ç”¨è€…æœ€ç»ˆåªéœ€è¦å’Œè¿™ä¸ªç±»äº¤äº’

### åŸºç¡€æ•°æ®ç»“æ„

* Ticker
* æŒ‰ç…§Cache Lineå¯¹é½çš„åŸºç¡€æ•°æ®ç»“æ„
* ç”¨æˆ·æœ€ç»ˆéœ€è¦è¯»å†™çš„æ•°æ®ç»“æ„

**Ticker ç»“æ„ä½“å¸ƒå±€ï¼ˆ64å­—èŠ‚ï¼‰**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ticker (alignas(64))                          â”‚   56 bytes    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Exchange exchange        (enum)               â”‚   4 bytes     â”‚
â”‚  CurrencyPair symbol      (enum)               â”‚   4 bytes     â”‚
â”‚  int64_t timestamp                             â”‚   8 bytes     â”‚
â”‚  int64_t localTimestamp                        â”‚   8 bytes     â”‚
â”‚  double askPrice                               â”‚   8 bytes     â”‚
â”‚  double askVolume                              â”‚   8 bytes     â”‚
â”‚  double bidPrice                               â”‚   8 bytes     â”‚
â”‚  double bidVolume                              â”‚   8 bytes     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [padding to cache line]                       â”‚   8 bytes     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        æ€»è®¡ï¼š64 **å­—èŠ‚**
```

### å…±äº«å†…å­˜å¸ƒå±€Ring Buffer

* SharedMemoryTickerData
* å…±äº«å†…å­˜çš„æ•°æ®ç»“æ„ï¼Œå°±æ˜¯Tickerçš„Ring Bufferï¼Œå¯¹åº”ç‰¹å®šäº¤æ˜“æ‰€ï¼Œç‰¹å®šäº¤æ˜“å¯¹çš„Ticker

**SharedMemoryTickerData å®Œæ•´å†…å­˜å¸ƒå±€**

```
åœ°å€åç§»                    å†…å®¹                              å¤§å°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

0x0000   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  std::atomic<uint64_t> writeIndex               â”‚  8 bytes
0x0008   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                                                 â”‚
         â”‚  char padding[56]                               â”‚ 56 bytes
         â”‚  (å¡«å……åˆ°å®Œæ•´ç¼“å­˜è¡Œï¼Œé¿å…ä¼ªå…±äº«)                   â”‚
         â”‚                                                 â”‚
0x0040   â”œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”¤ â† æ–°ç¼“å­˜è¡Œè¾¹ç•Œ
         â”‚  Ticker ringBuffer[0]                           â”‚ 64 bytes
0x0080   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚  Ticker ringBuffer[1]                           â”‚ 64 bytes
0x00C0   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚  Ticker ringBuffer[2]                           â”‚ 64 bytes
0x0100   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚  Ticker ringBuffer[3]                           â”‚ 64 bytes
         â”‚                    ...                          â”‚
         â”‚  (512 ä¸ª Ticker)                                â”‚
         â”‚                    ...                          â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚  Ticker ringBuffer[510]                         â”‚ 64 bytes
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚  Ticker ringBuffer[511]                         â”‚ 64 bytes
0x8040   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æ€»å¤§å° = 64 + 512 Ã— 64 = 64 + 32,768 = 32,832 bytes â‰ˆ 32 KB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**ç¼“å­˜è¡Œçº§åˆ«çš„å†…å­˜è§†å›¾**

```
Cache Line 0 (64 bytes):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ writeIndex â”‚            padding (56 bytes)                     â”‚
â”‚  (8 bytes) â”‚         é¿å…ä¸ ringBuffer åœ¨åŒä¸€ç¼“å­˜è¡Œ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘ å†™è€…é¢‘ç¹æ›´æ–°è¿™ä¸ªå€¼ï¼Œç‹¬å ä¸€ä¸ªç¼“å­˜è¡Œï¼Œä¸å½±å“è¯»è€…

Cache Line 1 (64 bytes):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ticker ringBuffer[0]                        â”‚
â”‚  (å®Œæ•´çš„ä¸€ä¸ª Ticker ç»“æ„ï¼Œåˆšå¥½å æ»¡ä¸€ä¸ªç¼“å­˜è¡Œ)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Cache Line 2 (64 bytes):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ticker ringBuffer[1]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

... (å…± 512 ä¸ª Tickerï¼Œæ¯ä¸ªå ä¸€ä¸ªç¼“å­˜è¡Œ) ...

Cache Line 512 (64 bytes):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ticker ringBuffer[511]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»å…± 513 ä¸ªç¼“å­˜è¡Œ = 513 Ã— 64 = 32,832 bytes
```

### Ring Bufferç®¡ç†ç±»

* SharedMemoryTickerRingBuffer
* å•ä¸ªRing Bufferçš„ç®¡ç†å™¨ï¼Œ**ç®¡ç†ä¸€ä¸ªç‰¹å®šäº¤æ˜“å¯¹çš„Tickerçš„å…±äº«å†…å­˜**ï¼Œè´Ÿè´£æ“ä½œSharedMemoryTickerDataï¼Œå¯¹å¤–ç»™å‡ºæ“ä½œæ¥å£
* æä¾›è¯»å†™æ¥å£ï¼Œæ”¯æŒé›¶æ‹·è´æ“ä½œ
* RAII é£æ ¼ï¼Œè‡ªåŠ¨ç®¡ç†èµ„æºç”Ÿå‘½å‘¨æœŸ


!!! warning "æ³¨æ„"

    * åœ¨ä½¿ç”¨è¿™ä¸ªç±»çš„æ—¶å€™è¦æ³¨æ„ï¼Œæ¯æ„é€ ä¸€ä¸ªå®ä¾‹ï¼Œä¼šè‡ªåŠ¨attachåˆ°å·²å­˜åœ¨çš„å…±äº«å†…å­˜ã€‚ä¸€ä¸ªè¿›ç¨‹å¦‚æœåˆ›å»ºå¤šä¸ªå®ä¾‹ï¼Œä¼šattachå¤šæ¬¡åˆ°åŒä¸€å—å†…å­˜ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„è¡Œä¸ºã€‚
    * è¿™ä¸ªç±»æ¯”è¾ƒåº•å±‚ï¼Œåœ¨å®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œä¸éœ€è¦ç›´æ¥è®¿é—®è¿™ä¸ªç±»ï¼Œç›´æ¥ä½¿ç”¨ä¸Šå±‚çš„`SharedMemoryTicker`ï¼Œä¼šè‡ªåŠ¨ç®¡ç†å¤šä¸ªäº¤æ˜“å¯¹çš„`SharedMemoryTickerData`ï¼ŒåŒæ—¶ä¼šé¿å…attachåˆ°åŒä¸€å—å†…å­˜å¤šæ¬¡è¿™æ ·çš„è¡Œä¸º

**Ring Bufferå·¥ä½œåŸç†**

```
åˆå§‹çŠ¶æ€ï¼šwriteIndex = 0
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚ 0 â”‚ 1 â”‚ 2 â”‚ 3 â”‚   ...   â”‚ 511 â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
  â†‘
writeIndex = 0 (æœ€æ–°æ•°æ®)

å†™å…¥ç¬¬ 1 æ¬¡ï¼šwriteIndex = 1
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚ 0 â”‚ 1 â”‚ 2 â”‚ 3 â”‚   ...   â”‚ 511 â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
      â†‘
writeIndex = 1 (æœ€æ–°æ•°æ®)

å†™å…¥ç¬¬ 512 æ¬¡ï¼šwriteIndex = 511
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚ 0 â”‚ 1 â”‚ 2 â”‚ 3 â”‚   ...   â”‚ 511 â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
                            â†‘
writeIndex = 511 (æœ€æ–°æ•°æ®)

å†™å…¥ç¬¬ 513 æ¬¡ï¼šwriteIndex = 0ï¼ˆå¾ªç¯ï¼‰
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚ 0 â”‚ 1 â”‚ 2 â”‚ 3 â”‚   ...   â”‚ 511 â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
  â†‘
writeIndex = 0 (è¦†ç›–æ—§æ•°æ®)
```

#### API

* å¯¹å¤–æš´éœ²çš„APIéå¸¸ç®€å•ï¼Œåªæœ‰å¦‚ä¸‹4ä¸ª
* æ”¯æŒæ•°æ®çš„è¯»å–
* æ”¯æŒæ•°æ®çš„å†™å…¥ï¼ˆæ‹·è´å’Œé›¶æ‹·è´ï¼‰

```c++
/**
 * æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–å…±äº«å†…å­˜ RingBuffer
 *
 * @param exchange äº¤æ˜“æ‰€ï¼ˆæšä¸¾ç±»å‹ï¼Œå¦‚ BINANCE, OKXï¼‰
 * @param symbol äº¤æ˜“å¯¹ï¼ˆæšä¸¾ç±»å‹ï¼Œå¦‚ BTC_USDT, ETH_USDTï¼‰
 * @param overwrite æ˜¯å¦è¦†ç›–å·²æœ‰çš„å…±äº«å†…å­˜ï¼ˆé»˜è®¤ falseï¼‰
 */
SharedMemoryTickerRingBuffer(const Exchange exchange, const CurrencyPair symbol, bool overwrite = false);

inline Ticker *get();

/**
 * å‘ RingBuffer å†™å…¥æ–°çš„ Ticker æ•°æ®
 *
 * @param ticker éœ€è¦å†™å…¥çš„ Ticker ç»“æ„
 */
inline void write(const Ticker &ticker);

/**
 * è·å–å¯å†™å…¥çš„ Ticker æŒ‡é’ˆï¼ˆé¿å…æ‹·è´ï¼‰
 *
 * @return æŒ‡å‘å¯å†™å…¥ä½ç½®çš„æŒ‡é’ˆ
 */
inline Ticker *getWritable();

/**
 * æäº¤å†™å…¥æ“ä½œï¼Œæ›´æ–° RingBuffer çš„å†™ç´¢å¼•
 */
inline void commit();
```

#### æ¡ˆä¾‹1ï¼šç”Ÿäº§è€…è¿›ç¨‹ï¼ˆæ‹·è´å¼å†™å…¥ï¼‰

```c++
SharedMemoryTickerRingBuffer buffer(
    Exchange::BINANCE, 
    CurrencyPair::BTC_USDT
);

Ticker ticker;
ticker.askPrice = 50000.0 + (rand() % 100);
ticker.askVolume = 1.5;
ticker.bidPrice = 49999.0 + (rand() % 100);
ticker.bidVolume = 2.0;

// ç›´æ¥å†™å…¥ï¼ˆæœ‰æ‹·è´ï¼‰ï¼Œä¼šæŠŠtickeræ‹·è´åˆ°åº•å±‚çš„Ring Bufferå¯¹åº”çš„slot
buffer.write(ticker);
```

#### æ¡ˆä¾‹2ï¼šç”Ÿäº§è€…è¿›ç¨‹ï¼ˆé›¶æ‹·è´ä¼˜åŒ–ç‰ˆï¼‰

* `buffer.getWritable()`å’Œ`buffer.commit()`æ“ä½œå¿…é¡»ä¸€ä¸€å¯¹åº”

```c++
SharedMemoryTickerRingBuffer buffer(
    Exchange::BINANCE, 
    CurrencyPair::BTC_USDT
);

// è·å–å¯å†™ä½ç½®çš„æŒ‡é’ˆ
Ticker* ptr = buffer.getWritable();

// æ›´æ–°ticker
// ç›´æ¥åœ¨å…±äº«å†…å­˜ä¸­å¡«å……æ•°æ®ï¼ˆé›¶æ‹·è´ï¼ï¼‰
ptr->askPrice = 50000.0 + (rand() % 100);
ptr->askVolume = 1.5;
ptr->bidPrice = 49999.0 + (rand() % 100);
ptr->bidVolume = 2.0;

// æäº¤å†™å…¥ï¼ˆæ›´æ–°ç´¢å¼•ï¼‰
buffer.commit();
```

#### æ¡ˆä¾‹3ï¼šæ¶ˆè´¹è€…è¿›ç¨‹ï¼ˆæ•°æ®è¯»å–æ–¹ï¼‰

```c++
SharedMemoryTickerRingBuffer buffer(
    Exchange::BINANCE, 
    CurrencyPair::BTC_USDT
);

// è·å–æœ€æ–°æ•°æ®ï¼ˆé›¶æ‹·è´ï¼Œç›´æ¥è¿”å›æŒ‡é’ˆï¼‰
Ticker* ticker = buffer.get();
std::cout << "Ask=" << ticker->askPrice << " "
          << "Bid=" << ticker->bidPrice << " "
          << "Time=" << ticker->timestamp << std::endl;
```

### å…¨å±€Ring Bufferç®¡ç†å™¨

* SharedMemoryTicker
* å…¨å±€ç»Ÿä¸€çš„ Ticker å…±äº«å†…å­˜ç®¡ç†å™¨ï¼Œç®¡ç†æ‰€æœ‰äº¤æ˜“æ‰€ã€æ‰€æœ‰äº¤æ˜“å¯¹çš„ Ticker å…±äº«å†…å­˜
* æä¾›å…¨å±€é™æ€æ¥å£ï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç† RingBuffer å®ä¾‹
* æ‡’åŠ è½½æœºåˆ¶ï¼šé¦–æ¬¡è®¿é—®æ—¶è‡ªåŠ¨åˆ›å»ºå…±äº«å†…å­˜
* è‡ªåŠ¨è·¯ç”±ï¼šæ ¹æ® exchange å’Œ symbol è‡ªåŠ¨æ‰¾åˆ°å¯¹åº”çš„ RingBufferï¼Œä½¿ç”¨ä½è¿ç®—ç¼–ç ï¼Œæ›´é«˜æ•ˆçš„æ„å»ºkey


**å¤šè¿›ç¨‹è®¿é—®ç¤ºæ„å›¾**

```
è¿›ç¨‹ A (ç”Ÿäº§è€…)                           å…±äº«å†…å­˜
    â”‚                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ write(ticker)                  â”‚  writeIndex: 5  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                     â”‚  Ticker [0]     â”‚
                                     â”‚  Ticker [1]     â”‚
                                     â”‚  Ticker [2]     â”‚
                                     â”‚  Ticker [3]     â”‚
                                     â”‚  Ticker [4]     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  Ticker [5] â†â”€â”€ â”‚ æœ€æ–°
    â”‚ get() â†’ Ticker[5]              â”‚  Ticker [6]     â”‚
    â”‚                                â”‚    ...          â”‚
è¿›ç¨‹ B (æ¶ˆè´¹è€…1)                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â†‘
è¿›ç¨‹ C (æ¶ˆè´¹è€…2)                            â”‚
    â”‚                                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    get() â†’ Ticker[5]
```

#### API

* å¯¹å¤–æš´éœ²çš„APIéå¸¸ç®€å•ï¼Œåªæœ‰å¦‚ä¸‹5ä¸ª
* æ”¯æŒæ•°æ®çš„è¯»å–ï¼ˆæ‹·è´å’Œé›¶æ‹·è´ï¼‰
* æ”¯æŒæ•°æ®çš„å†™å…¥ï¼ˆæ‹·è´å’Œé›¶æ‹·è´ï¼‰

```c++
/**
 * å†™å…¥ Ticker æ•°æ®
 *
 * @param ticker éœ€è¦å†™å…¥çš„ Ticker ç»“æ„ä½“
 */
static inline void write(const Ticker &ticker);

/**
 * è·å–æœ€æ–°çš„ Ticker æ•°æ®
 *
 * @param exchange äº¤æ˜“æ‰€ï¼ˆæšä¸¾ç±»å‹ï¼Œå¦‚ BINANCE, OKXï¼‰
 * @param symbol äº¤æ˜“å¯¹ï¼ˆæšä¸¾ç±»å‹ï¼Œå¦‚ BTC_USDT, ETH_USDTï¼‰
 * @return æŒ‡å‘æœ€æ–° Ticker æ•°æ®çš„æŒ‡é’ˆ
 */
static inline Ticker *get(const Exchange exchange, const CurrencyPair symbol);

/**
 * è·å–æœ€æ–°çš„ Tickeræ‹·è´ æ•°æ®
 *
 * @param exchange äº¤æ˜“æ‰€ï¼ˆæšä¸¾ç±»å‹ï¼Œå¦‚ BINANCE, OKXï¼‰
 * @param symbol äº¤æ˜“å¯¹ï¼ˆæšä¸¾ç±»å‹ï¼Œå¦‚ BTC_USDT, ETH_USDTï¼‰
 * @return æœ€æ–° Ticker çš„æ‹·è´
 */
static inline Ticker getCopy(const Exchange exchange, const CurrencyPair symbol);

/**
 * è·å–å¯å†™å…¥çš„ Ticker æŒ‡é’ˆï¼Œé¿å…æ‹·è´
 *
 * @param exchange äº¤æ˜“æ‰€ï¼ˆæšä¸¾ç±»å‹ï¼Œå¦‚ BINANCE, OKXï¼‰
 * @param symbol äº¤æ˜“å¯¹ï¼ˆæšä¸¾ç±»å‹ï¼Œå¦‚ BTC_USDT, ETH_USDTï¼‰
 * @return æŒ‡å‘å¯å†™å…¥ä½ç½®çš„æŒ‡é’ˆ
 */
static inline Ticker *getWritable(const Exchange exchange, const CurrencyPair symbol);

/**
 * æäº¤å†™å…¥çš„ Ticker æ•°æ®
 *
 * @param exchange äº¤æ˜“æ‰€ï¼ˆæšä¸¾ç±»å‹ï¼Œå¦‚ BINANCE, OKXï¼‰
 * @param symbol äº¤æ˜“å¯¹ï¼ˆæšä¸¾ç±»å‹ï¼Œå¦‚ BTC_USDT, ETH_USDTï¼‰
 */
static inline void commit(const Exchange exchange, const CurrencyPair symbol);
```

#### ğŸ”¥ æ¡ˆä¾‹1ï¼šç”Ÿäº§è€…è¿›ç¨‹ï¼ˆæ‹·è´å¼å†™å…¥ï¼‰

```c++
// è§£æ JSON åˆ° Ticker
Ticker ticker = parseFromJson(json);

// ç›´æ¥å†™å…¥ï¼ˆæœ€ç®€å•ï¼‰
// è‡ªåŠ¨æ ¹æ® ticker.exchange å’Œ ticker.symbol è·¯ç”±åˆ°å¯¹åº”çš„å…±äº«å†…å­˜
ShareMemoryTicker::write(ticker);  
```

#### ğŸ”¥ æ¡ˆä¾‹2ï¼šç”Ÿäº§è€…è¿›ç¨‹ï¼ˆé›¶æ‹·è´ä¼˜åŒ–ï¼‰


```c++
// äº¤æ˜“æ‰€å’Œäº¤æ˜“å¯¹
Exchange exchange = Exchange::BINANCE;
CurrencyPair symbol = CurrencyPair::BTC_USDT;

// è·å–å…±äº«å†…å­˜ä¸­çš„å¯å†™ä½ç½®
Ticker* ptr = ShareMemoryTicker::getWritable(exchange, symbol);

// ç›´æ¥åœ¨å…±äº«å†…å­˜ä¸­è§£æå’Œå¡«å……æ•°æ®ï¼ˆé¿å…ä¸´æ—¶å¯¹è±¡ï¼‰
auto doc = parser.iterate(json);
ptr->exchange = exchange;
ptr->symbol = symbol;
ptr->timestamp = doc["E"].get_int64();
ptr->localTimestamp = getCurrentTimestamp();
ptr->askPrice = doc["a"].get_double();
ptr->askVolume = doc["A"].get_double();
ptr->bidPrice = doc["b"].get_double();
ptr->bidVolume = doc["B"].get_double();
    
// æäº¤å†™å…¥ï¼ˆæ›´æ–°ç´¢å¼•ï¼Œè®©æ¶ˆè´¹è€…å¯è§ï¼‰
ShareMemoryTicker::commit(exchange, symbol);
```

#### ğŸ”¥ æ¡ˆä¾‹3ï¼šæ¶ˆè´¹è€…è¿›ç¨‹ï¼ˆæ•°æ®è¯»å–æ–¹ï¼‰

```c++
// äº¤æ˜“æ‰€å’Œäº¤æ˜“å¯¹
Exchange exchange = Exchange::BINANCE;
CurrencyPair symbol = CurrencyPair::BTC_USDT;

// è¯»å–æœ€æ–°çš„ Ticker æ•°æ®
Ticker* ticker = ShareMemoryTicker::get(exchange, symbol);

std::cout << "Ask=" << ticker->askPrice << " "
          << "Bid=" << ticker->bidPrice << " "
          << "Spread=" << (ticker->askPrice - ticker->bidPrice)
          << std::endl;
```